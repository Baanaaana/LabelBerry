<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LabelBerry</title>
    
    <!-- Favicon using Lucide receipt-text icon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%234263eb' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1-2-1Z'/%3E%3Cpath d='M14 8H8'/%3E%3Cpath d='M16 12H8'/%3E%3Cpath d='M13 16H8'/%3E%3C/svg%3E">
    
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-left">
                <i data-lucide="receipt-text"></i>
                <h1>LabelBerry</h1>
            </div>
            <div class="header-right">
                <a href="/docs" class="icon-btn" title="API Documentation" style="text-decoration: none;">
                    <i data-lucide="book-open"></i>
                </a>
                <a href="/settings" class="icon-btn" title="Settings" style="text-decoration: none;">
                    <i data-lucide="settings"></i>
                </a>
                <button class="icon-btn" onclick="refreshDashboard()" title="Refresh">
                    <i data-lucide="refresh-cw"></i>
                </button>
                <a href="/logout" class="icon-btn" title="Logout" style="text-decoration: none;">
                    <i data-lucide="log-out"></i>
                </a>
            </div>
        </header>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Active Printers</span>
                    <i data-lucide="printer" class="stat-icon green"></i>
                </div>
                <div class="stat-value" id="online-pis">0</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Total Printers</span>
                    <i data-lucide="package-2" class="stat-icon blue"></i>
                </div>
                <div class="stat-value" id="total-pis">0</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Jobs Today</span>
                    <i data-lucide="file-text" class="stat-icon purple"></i>
                </div>
                <div class="stat-value" id="jobs-today">0</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Queue Status</span>
                    <i data-lucide="clock" class="stat-icon orange"></i>
                </div>
                <div class="stat-value" id="queue-status">0</div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Quick Actions Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h2>Quick Actions</h2>
                </div>
                <div class="panel-content">
                    <button class="action-btn" onclick="showRegisterModal()">
                        <i data-lucide="plus-circle"></i>
                        <span>Register Printer</span>
                    </button>
                    <button class="action-btn" onclick="showBroadcastModal()">
                        <i data-lucide="send"></i>
                        <span>Broadcast Print</span>
                    </button>
                    <button class="action-btn" onclick="viewLogs()">
                        <i data-lucide="file-text"></i>
                        <span>View Logs</span>
                    </button>
                    <button class="action-btn" onclick="showMetrics()">
                        <i data-lucide="bar-chart-2"></i>
                        <span>Performance Metrics</span>
                    </button>
                </div>
            </div>

            <!-- Printers List -->
            <div class="panel flex-grow">
                <div class="panel-header">
                    <h2>Printers</h2>
                    <div class="panel-actions">
                        <input type="text" class="search-input" placeholder="Search printers..." onkeyup="searchPrinters(this.value)">
                    </div>
                </div>
                <div class="panel-content">
                    <div id="printers-list" class="printers-list">
                        <!-- Printer items will be dynamically added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Printer Modal -->
    <div id="register-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Register New Printer</h2>
                <button class="modal-close" onclick="closeRegisterModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <form id="register-form" onsubmit="registerPi(event)">
                <div class="form-group">
                    <label for="device-id">Device ID</label>
                    <input type="text" id="device-id" required placeholder="Enter Device ID from Pi">
                </div>
                <div class="form-group">
                    <label for="api-key">API Key</label>
                    <input type="text" id="api-key" required placeholder="Enter API Key from Pi">
                </div>
                <div class="form-group">
                    <label for="friendly-name">Friendly Name</label>
                    <input type="text" id="friendly-name" required placeholder="e.g., Warehouse Printer 1">
                </div>
                <div class="form-group">
                    <label for="location">Location</label>
                    <input type="text" id="location" placeholder="e.g., Building A, Floor 2">
                </div>
                <div class="form-group">
                    <label for="printer-model">Printer Model</label>
                    <input type="text" id="printer-model" placeholder="e.g., Zebra ZD220">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeRegisterModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Register Printer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Test Print Modal -->
    <div id="print-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Send Print Job to <span id="print-pi-name"></span></h2>
                <button class="modal-close" onclick="closePrintModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <form id="print-form" onsubmit="sendPrint(event)">
                <div class="form-tabs">
                    <button type="button" class="tab-btn active" onclick="switchPrintTab('raw')">Raw ZPL</button>
                    <button type="button" class="tab-btn" onclick="switchPrintTab('file')">File Upload</button>
                    <button type="button" class="tab-btn" onclick="switchPrintTab('url')">URL</button>
                </div>
                
                <div id="raw-input" class="tab-content active">
                    <div class="form-group">
                        <label for="label-size-select">Label Size Template</label>
                        <select id="label-size-select" onchange="updateTestZPL()" class="form-control">
                            <option value="small">57mm x 32mm (Small shipping label)</option>
                            <option value="large">102mm x 150mm (Large shipping label)</option>
                            <option value="custom">Custom ZPL</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="zpl-raw">ZPL Code</label>
                        <textarea id="zpl-raw" rows="10" placeholder="Enter ZPL code..."></textarea>
                    </div>
                </div>
                
                <div id="file-input" class="tab-content">
                    <div class="form-group">
                        <label for="zpl-file">Select ZPL File</label>
                        <input type="file" id="zpl-file" accept=".zpl,.txt">
                    </div>
                </div>
                
                <div id="url-input" class="tab-content">
                    <div class="form-group">
                        <label for="zpl-url">ZPL URL</label>
                        <input type="url" id="zpl-url" placeholder="https://example.com/label.zpl">
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closePrintModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Print Job</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Printer Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Printer</h2>
                <button class="modal-close" onclick="closeEditModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <form id="edit-form" onsubmit="updatePi(event)">
                <input type="hidden" id="edit-pi-id">
                <div class="form-group">
                    <label for="edit-friendly-name">Friendly Name</label>
                    <input type="text" id="edit-friendly-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-location">Location</label>
                    <input type="text" id="edit-location" placeholder="e.g., Building A, Floor 2">
                </div>
                <div class="form-group">
                    <label for="edit-printer-model">Printer Model</label>
                    <input type="text" id="edit-printer-model" placeholder="e.g., Zebra ZD220">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal">
        <div class="modal-content compact">
            <div class="modal-header">
                <h2>Delete Printer</h2>
                <button class="modal-close" onclick="closeDeleteModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="delete-pi-name"></strong>?</p>
                <p class="warning-text">This action cannot be undone.</p>
            </div>
            <input type="hidden" id="delete-pi-id">
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Broadcast Print Modal -->
    <div id="broadcast-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Broadcast Print to All Printers</h2>
                <button class="modal-close" onclick="closeBroadcastModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <form id="broadcast-form" onsubmit="sendBroadcast(event)">
                <div class="form-group">
                    <label>Select Printers</label>
                    <div id="broadcast-printer-list" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 12px;">
                        <!-- Printer checkboxes will be added here -->
                    </div>
                </div>
                
                <div class="form-tabs">
                    <button type="button" class="tab-btn active" onclick="switchBroadcastTab('raw')">Raw ZPL</button>
                    <button type="button" class="tab-btn" onclick="switchBroadcastTab('url')">URL</button>
                </div>
                
                <div id="broadcast-raw-input" class="tab-content active">
                    <div class="form-group">
                        <label for="broadcast-zpl-raw">ZPL Code</label>
                        <textarea id="broadcast-zpl-raw" rows="8" placeholder="Enter ZPL code...">^XA
^FO50,50^A0N,40,40^FDBroadcast Test^FS
^FO50,100^A0N,25,25^FDSent to all printers^FS
^XZ</textarea>
                    </div>
                </div>
                
                <div id="broadcast-url-input" class="tab-content">
                    <div class="form-group">
                        <label for="broadcast-zpl-url">ZPL URL</label>
                        <input type="url" id="broadcast-zpl-url" placeholder="https://example.com/label.zpl">
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeBroadcastModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i data-lucide="send"></i> Send to Selected Printers
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Logs Modal -->
    <div id="logs-modal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>System Logs</h2>
                <button class="modal-close" onclick="closeLogsModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="padding: 0;">
                    <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                        <select id="log-pi-filter" onchange="filterLogs()" class="form-control" style="flex: 1;">
                            <option value="">All Printers</option>
                        </select>
                        <select id="log-level-filter" onchange="filterLogs()" class="form-control" style="width: 150px;">
                            <option value="">All Levels</option>
                            <option value="ERROR">Errors</option>
                            <option value="WARNING">Warnings</option>
                            <option value="INFO">Info</option>
                        </select>
                        <button class="btn btn-primary" onclick="refreshLogs()">
                            <i data-lucide="refresh-cw"></i> Refresh
                        </button>
                    </div>
                </div>
                <div id="logs-container" style="max-height: 500px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 16px; font-family: monospace; font-size: 12px;">
                    <!-- Logs will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Metrics Modal -->
    <div id="metrics-modal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h2>Performance Metrics</h2>
                <button class="modal-close" onclick="closeMetricsModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="padding: 0;">
                    <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                        <select id="metrics-pi-filter" onchange="loadMetrics()" class="form-control" style="flex: 1;">
                            <option value="">All Printers</option>
                        </select>
                        <select id="metrics-time-range" onchange="loadMetrics()" class="form-control" style="width: 150px;">
                            <option value="1">Last Hour</option>
                            <option value="6">Last 6 Hours</option>
                            <option value="24" selected>Last 24 Hours</option>
                            <option value="168">Last Week</option>
                        </select>
                    </div>
                </div>
                
                <!-- Metrics Summary Cards -->
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">Avg CPU Usage</span>
                            <i data-lucide="cpu" class="stat-icon blue"></i>
                        </div>
                        <div class="stat-value" id="avg-cpu">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">Avg Memory</span>
                            <i data-lucide="hard-drive" class="stat-icon purple"></i>
                        </div>
                        <div class="stat-value" id="avg-memory">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">Total Jobs</span>
                            <i data-lucide="file-text" class="stat-icon green"></i>
                        </div>
                        <div class="stat-value" id="total-jobs">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">Success Rate</span>
                            <i data-lucide="check-circle" class="stat-icon green"></i>
                        </div>
                        <div class="stat-value" id="success-rate">0%</div>
                    </div>
                </div>
                
                <!-- Metrics Table -->
                <div style="background: var(--bg-primary); border-radius: 8px; padding: 16px;">
                    <h3 style="margin: 0 0 16px 0; font-size: 16px;">Detailed Metrics</h3>
                    <div style="overflow-x: auto;">
                        <table id="metrics-table" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 2px solid var(--border-color);">
                                    <th style="text-align: left; padding: 8px;">Printer</th>
                                    <th style="text-align: center; padding: 8px;">CPU %</th>
                                    <th style="text-align: center; padding: 8px;">Memory %</th>
                                    <th style="text-align: center; padding: 8px;">Queue</th>
                                    <th style="text-align: center; padding: 8px;">Jobs</th>
                                    <th style="text-align: center; padding: 8px;">Failed</th>
                                    <th style="text-align: left; padding: 8px;">Last Update</th>
                                </tr>
                            </thead>
                            <tbody id="metrics-tbody">
                                <!-- Metrics rows will be added here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Floating GitHub Button -->
    <a href="https://github.com/Baanaaana/LabelBerry" 
       target="_blank" 
       class="github-float" 
       title="View on GitHub">
        <i data-lucide="github" style="stroke: white;"></i>
    </a>

    <script src="/static/js/dashboard.js"></script>
    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        
        // Re-initialize icons after dynamic content updates
        const originalRenderPrinters = window.renderPrinters;
        window.renderPrinters = function(pis) {
            originalRenderPrinters(pis);
            setTimeout(() => lucide.createIcons(), 10);
        };
    </script>
</body>
</html>