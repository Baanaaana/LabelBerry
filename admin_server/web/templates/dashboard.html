<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LabelBerry</title>
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="LabelBerry">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="LabelBerry">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4263eb">
    <meta name="description" content="LabelBerry Label Printing Management System">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="/static/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/static/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/static/icons/icon-192x192.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/static/icons/labelberry-icon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/icons/icon-72x72.png">
    
    <!-- iOS Splash Screens (optional) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Google Fonts - Ubuntu -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="/static/css/dashboard.css?v={{ static_version }}">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <!-- Header -->
    <header class="dashboard-header">
        <div class="header-left">
            <a href="/" style="display: flex; align-items: center; gap: 12px; text-decoration: none;">
                <i data-lucide="receipt-text" style="color: var(--primary-color); width: 24px; height: 24px;"></i>
                <h1 style="font-size: 24px; font-weight: 600; color: var(--text-primary); margin: 0;">LabelBerry</h1>
            </a>
        </div>
        <div class="header-center">
            <h1>Dashboard</h1>
        </div>
        <div class="header-right">
            <button class="icon-btn" onclick="refreshDashboard()" title="Refresh">
                <i data-lucide="refresh-cw"></i>
            </button>
            <a href="/logout" class="icon-btn" title="Logout" style="text-decoration: none;">
                <i data-lucide="log-out"></i>
            </a>
        </div>
    </header>

    <div class="dashboard-container">
        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Server Address</span>
                    <i data-lucide="server" class="stat-icon slate"></i>
                </div>
                <div class="stat-value" style="font-size: 20px;">
                    <span id="server-ip" class="server-ip-clickable" onclick="copyServerAddress()" title="Click to copy">Loading...</span>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Active Printers</span>
                    <i data-lucide="printer" class="stat-icon green"></i>
                </div>
                <div class="stat-value" id="online-pis">0</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Total Printers</span>
                    <i data-lucide="package-2" class="stat-icon blue"></i>
                </div>
                <div class="stat-value" id="total-pis">0</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Jobs Today</span>
                    <i data-lucide="file-text" class="stat-icon purple"></i>
                </div>
                <div class="stat-value" id="jobs-today">0</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Queue Status</span>
                    <i data-lucide="clock" class="stat-icon orange"></i>
                </div>
                <div class="stat-value" id="queue-status">0</div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Management Tools Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h2>Management Tools</h2>
                </div>
                <div class="panel-content" style="padding: 12px;">
                    <nav class="management-nav">
                        <a href="#" id="nav-add-printer" class="nav-item" onclick="showRegisterModal(); return false;">
                            <i data-lucide="plus-circle"></i>
                            <span>Add Printer</span>
                        </a>
                        <a href="#" id="nav-broadcast" class="nav-item" onclick="showBroadcastModal(); return false;">
                            <i data-lucide="send"></i>
                            <span>Broadcast Print</span>
                        </a>
                        <a href="#" id="nav-queue" class="nav-item" onclick="showQueueModal(); return false;">
                            <i data-lucide="list-ordered"></i>
                            <span>Queue Management</span>
                        </a>
                        <a href="/print-history" class="nav-item">
                            <i data-lucide="history"></i>
                            <span>Print History</span>
                        </a>
                        <a href="#" id="nav-logs" class="nav-item" onclick="viewLogs(); return false;">
                            <i data-lucide="file-text"></i>
                            <span>System Logs</span>
                        </a>
                        <a href="#" id="nav-metrics" class="nav-item" onclick="showMetrics(); return false;">
                            <i data-lucide="bar-chart-2"></i>
                            <span>Performance Metrics</span>
                        </a>
                        <a href="/api-docs" class="nav-item">
                            <i data-lucide="book-open"></i>
                            <span>API Documentation</span>
                        </a>
                        <a href="#settings" id="nav-settings" class="nav-item" onclick="toggleSettingsPanel(); return false;">
                            <i data-lucide="settings"></i>
                            <span>Settings</span>
                        </a>
                    </nav>
                </div>
            </div>

            <!-- Printers List -->
            <div id="printers-panel" class="panel flex-grow">
                <div class="panel-header">
                    <h2 id="printers-panel-title">Printers</h2>
                    <div class="panel-actions">
                        <input type="text" class="search-input" placeholder="Search printers..." onkeyup="filterPrinters()">
                    </div>
                </div>
                <div class="panel-content">
                    <!-- Filter Controls -->
                    <div class="filter-controls" style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                        <select id="status-filter" class="filter-select" onchange="filterPrinters()" style="padding: 6px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 13px; background: var(--bg-primary);">
                            <option value="">All Status</option>
                            <option value="online">Online</option>
                            <option value="offline">Offline</option>
                        </select>
                        <select id="label-size-filter" class="filter-select" onchange="filterPrinters()" style="padding: 6px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 13px; background: var(--bg-primary);">
                            <option value="">All Label Sizes</option>
                            <option value="none">No Label Size Set</option>
                        </select>
                        <button onclick="clearFilters()" style="padding: 6px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 13px; background: var(--bg-primary); cursor: pointer; color: var(--text-secondary);">
                            Clear Filters
                        </button>
                    </div>
                    <div id="printers-list" class="printers-list">
                        <!-- Printer items will be dynamically added here -->
                    </div>
                </div>
            </div>

            <!-- Settings Panel (initially hidden) -->
            <div id="settings-panel" class="panel flex-grow" style="display: none;">
                <div class="panel-header">
                    <h2>Settings</h2>
                    <div class="panel-actions">
                        <button class="icon-btn" onclick="toggleSettingsPanel()" title="Close Settings">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                </div>
                <div class="panel-content">
                    <!-- Settings Navigation -->
                    <div class="settings-tabs" style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 12px; flex-wrap: wrap;">
                        <button class="settings-tab active" onclick="switchSettingsTab('account', this)">
                            <i data-lucide="user"></i>
                            Account
                        </button>
                        <button class="settings-tab" onclick="switchSettingsTab('system', this)">
                            <i data-lucide="settings"></i>
                            System
                        </button>
                        <button class="settings-tab" onclick="switchSettingsTab('api-keys', this)">
                            <i data-lucide="key"></i>
                            API Keys
                        </button>
                        <button class="settings-tab" onclick="switchSettingsTab('label-sizes', this)">
                            <i data-lucide="ruler"></i>
                            Label Sizes
                        </button>
                    </div>

                    <!-- Account Section (Account + Security combined) -->
                    <div id="account-settings" class="settings-content active">
                        <h3 style="margin-top: 0;">Account & Security</h3>
                        
                        <!-- Combined Account Form -->
                        <div class="settings-card">
                            <h4>Update Account Credentials</h4>
                            <p style="color: var(--text-secondary); margin-bottom: 20px;">Change your username and/or password. Leave fields blank to keep current values.</p>
                            <form id="account-form" onsubmit="updateAccount(event); return false;">
                                <!-- Current Password (Required for any change) -->
                                <div style="background: var(--bg-primary); padding: 16px; border-radius: 6px; margin-bottom: 20px;">
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <label for="current-password">Current Password *</label>
                                        <input type="password" id="current-password" class="form-control" placeholder="Enter your current password" required>
                                        <small style="color: var(--text-secondary);">Required to make any changes</small>
                                    </div>
                                </div>

                                <!-- Username Change Section -->
                                <div style="border-left: 3px solid var(--primary-color); padding-left: 16px; margin-bottom: 20px;">
                                    <h5 style="margin: 0 0 12px 0; color: var(--text-primary);">Change Username</h5>
                                    <div class="form-group">
                                        <label for="new-username">New Username</label>
                                        <input type="text" id="new-username" class="form-control" placeholder="Leave blank to keep current username" minlength="3">
                                    </div>
                                </div>

                                <!-- Password Change Section -->
                                <div style="border-left: 3px solid var(--primary-color); padding-left: 16px; margin-bottom: 20px;">
                                    <h5 style="margin: 0 0 12px 0; color: var(--text-primary);">Change Password</h5>
                                    <div class="form-group">
                                        <label for="new-password">New Password</label>
                                        <input type="password" id="new-password" class="form-control" placeholder="Leave blank to keep current password" minlength="6">
                                        <small style="color: var(--text-secondary);">Minimum 6 characters</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="confirm-password">Confirm New Password</label>
                                        <input type="password" id="confirm-password" class="form-control" placeholder="Re-enter new password" minlength="6">
                                    </div>
                                </div>

                                <!-- Submit Button -->
                                <div style="display: flex; gap: 12px;">
                                    <button type="submit" class="btn btn-primary">
                                        <i data-lucide="save" style="width: 16px; height: 16px;"></i>
                                        Update Account
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="resetAccountForm()">
                                        <i data-lucide="x" style="width: 16px; height: 16px;"></i>
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- System Section (Preferences + About combined) -->
                    <div id="system-settings" class="settings-content" style="display: none;">
                        <h3 style="margin-top: 0;">System Settings</h3>
                        
                        <!-- Preferences -->
                        <div class="settings-card" style="margin-bottom: 20px;">
                            <h4>Display Preferences</h4>
                            <form id="preferences-form" onsubmit="savePreferences(event); return false;">
                                <div class="form-group">
                                    <label for="timezone-select">Timezone</label>
                                    <select id="timezone-select" class="form-control">
                                        <option value="Europe/Amsterdam">Amsterdam (CET/CEST)</option>
                                        <option value="America/New_York">New York (EST/EDT)</option>
                                        <option value="UTC">UTC</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="refresh-interval">Auto-refresh Interval</label>
                                    <select id="refresh-interval" class="form-control">
                                        <option value="5000">5 seconds</option>
                                        <option value="10000">10 seconds</option>
                                        <option value="30000">30 seconds</option>
                                        <option value="0">Disabled</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">Save Preferences</button>
                            </form>
                        </div>

                        <!-- About -->
                        <div class="settings-card">
                            <h4>About LabelBerry</h4>
                            <div class="info-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 16px;">
                                <div class="info-item">
                                    <span style="color: var(--text-secondary); display: block; margin-bottom: 4px;">Version</span>
                                    <span style="font-weight: 500;">1.0.0</span>
                                </div>
                                <div class="info-item">
                                    <span style="color: var(--text-secondary); display: block; margin-bottom: 4px;">Server Status</span>
                                    <span class="status-badge status-success" style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500;">Online</span>
                                </div>
                                <div class="info-item">
                                    <span style="color: var(--text-secondary); display: block; margin-bottom: 4px;">Database</span>
                                    <span style="font-weight: 500;">SQLite</span>
                                </div>
                                <div class="info-item">
                                    <span style="color: var(--text-secondary); display: block; margin-bottom: 4px;">GitHub</span>
                                    <a href="https://github.com/Baanaaana/LabelBerry" target="_blank" style="color: var(--primary-color); text-decoration: none;">
                                        View Repository
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- API Keys Section -->
                    <div id="api-keys-settings" class="settings-content" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0;">API Keys</h3>
                            <button class="btn btn-primary" onclick="showCreateKeyModal()">
                                <i data-lucide="plus"></i>
                                Create New Key
                            </button>
                        </div>
                        <div id="api-keys-list">
                            <!-- API keys will be loaded here -->
                        </div>
                    </div>

                    <!-- Label Sizes Section -->
                    <div id="label-sizes-settings" class="settings-content" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0;">Label Sizes</h3>
                            <button class="btn btn-primary" onclick="showAddLabelSizeModal()">
                                <i data-lucide="plus"></i>
                                Add Label Size
                            </button>
                        </div>
                        <div id="label-sizes-list">
                            <!-- Label sizes will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Printer Modal -->
    <div id="register-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Printer</h2>
                <button class="modal-close" onclick="closeRegisterModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <form id="register-form" onsubmit="registerPi(event)">
                <div class="form-group">
                    <label for="device-id">Device ID</label>
                    <input type="text" id="device-id" required placeholder="Enter Device ID from Pi">
                </div>
                <div class="form-group">
                    <label for="api-key">API Key</label>
                    <input type="text" id="api-key" required placeholder="Enter API Key from Pi">
                </div>
                <div class="form-group">
                    <label for="friendly-name">Friendly Name</label>
                    <input type="text" id="friendly-name" required placeholder="e.g., Warehouse Printer 1">
                </div>
                <div class="form-group">
                    <label for="device-name">Device Name</label>
                    <input type="text" id="device-name" placeholder="e.g., raspberrypi-01">
                </div>
                <div class="form-group">
                    <label for="location">Location</label>
                    <input type="text" id="location" placeholder="e.g., Building A, Floor 2">
                </div>
                <div class="form-group">
                    <label for="label-size">Label Size</label>
                    <select id="label-size" class="form-control">
                        <option value="">Select label size...</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeRegisterModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Printer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Test Print Modal -->
    <div id="print-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Send Print Job to <span id="print-pi-name"></span></h2>
                <button class="modal-close" onclick="closePrintModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <form id="print-form" onsubmit="sendPrint(event)">
                <div class="form-tabs">
                    <button type="button" class="tab-btn active" onclick="switchPrintTab('raw')">Raw ZPL</button>
                    <button type="button" class="tab-btn" onclick="switchPrintTab('file')">File Upload</button>
                    <button type="button" class="tab-btn" onclick="switchPrintTab('url')">URL</button>
                </div>
                
                <div id="raw-input" class="tab-content active">
                    <div class="form-group">
                        <label for="label-size-select">Label Size Template</label>
                        <select id="label-size-select" onchange="updateTestZPL()" class="form-control">
                            <option value="small">57mm x 32mm (Small shipping label)</option>
                            <option value="large">102mm x 150mm (Large shipping label)</option>
                            <option value="custom">Custom ZPL</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="zpl-raw">ZPL Code</label>
                        <textarea id="zpl-raw" rows="10" placeholder="Enter ZPL code..."></textarea>
                    </div>
                </div>
                
                <div id="file-input" class="tab-content">
                    <div class="form-group">
                        <label for="zpl-file">Select ZPL File</label>
                        <input type="file" id="zpl-file" accept=".zpl,.txt">
                    </div>
                </div>
                
                <div id="url-input" class="tab-content">
                    <div class="form-group">
                        <label for="zpl-url">ZPL URL</label>
                        <input type="url" id="zpl-url" placeholder="https://example.com/label.zpl">
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closePrintModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Print Job</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Printer Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Printer</h2>
                <button class="modal-close" onclick="closeEditModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <form id="edit-form" onsubmit="updatePi(event)">
                <input type="hidden" id="edit-pi-id">
                <div class="form-group">
                    <label for="edit-friendly-name">Friendly Name</label>
                    <input type="text" id="edit-friendly-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-device-name">Device Name</label>
                    <input type="text" id="edit-device-name" placeholder="e.g., raspberrypi-01">
                </div>
                <div class="form-group">
                    <label for="edit-location">Location</label>
                    <input type="text" id="edit-location" placeholder="e.g., Building A, Floor 2">
                </div>
                <div class="form-group">
                    <label for="edit-label-size">Label Size</label>
                    <select id="edit-label-size" class="form-control">
                        <option value="">Select label size...</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal">
        <div class="modal-content compact">
            <div class="modal-header">
                <h2>Delete Printer</h2>
                <button class="modal-close" onclick="closeDeleteModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="delete-pi-name"></strong>?</p>
                <p class="warning-text">This action cannot be undone.</p>
            </div>
            <input type="hidden" id="delete-pi-id">
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Broadcast Print Modal -->
    <div id="broadcast-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Broadcast Print to All Printers</h2>
                <button class="modal-close" onclick="closeBroadcastModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <form id="broadcast-form" onsubmit="sendBroadcast(event)">
                <div class="form-group">
                    <label>Select Printers</label>
                    <div id="broadcast-printer-list" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 12px;">
                        <!-- Printer checkboxes will be added here -->
                    </div>
                </div>
                
                <div class="form-tabs">
                    <button type="button" class="tab-btn active" onclick="switchBroadcastTab('raw')">Raw ZPL</button>
                    <button type="button" class="tab-btn" onclick="switchBroadcastTab('url')">URL</button>
                </div>
                
                <div id="broadcast-raw-input" class="tab-content active">
                    <div class="form-group">
                        <label for="broadcast-zpl-raw">ZPL Code</label>
                        <textarea id="broadcast-zpl-raw" rows="8" placeholder="Enter ZPL code...">^XA
^FO50,50^A0N,40,40^FDBroadcast Test^FS
^FO50,100^A0N,25,25^FDSent to all printers^FS
^XZ</textarea>
                    </div>
                </div>
                
                <div id="broadcast-url-input" class="tab-content">
                    <div class="form-group">
                        <label for="broadcast-zpl-url">ZPL URL</label>
                        <input type="url" id="broadcast-zpl-url" placeholder="https://example.com/label.zpl">
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeBroadcastModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i data-lucide="send"></i> Send to Selected Printers
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Logs Modal -->
    <div id="logs-modal" class="modal">
        <div class="modal-content" style="max-width: 1400px;">
            <div class="modal-header">
                <h2>System Logs</h2>
                <button class="modal-close" onclick="closeLogsModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="padding: 0;">
                    <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                        <select id="log-pi-filter" onchange="filterLogs()" class="form-control" style="flex: 1;">
                            <option value="">All Sources</option>
                        </select>
                        <select id="log-level-filter" onchange="filterLogs()" class="form-control" style="width: 150px;">
                            <option value="">All Levels</option>
                            <option value="ERROR">Errors</option>
                            <option value="WARNING">Warnings</option>
                            <option value="INFO">Info</option>
                        </select>
                        <button class="btn btn-primary" onclick="refreshLogs()">
                            <i data-lucide="refresh-cw"></i> Refresh
                        </button>
                    </div>
                </div>
                <div id="logs-container" style="max-height: 500px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 16px; font-family: monospace; font-size: 12px;">
                    <!-- Logs will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Metrics Modal -->
    <div id="metrics-modal" class="modal">
        <div class="modal-content" style="max-width: 1400px;">
            <div class="modal-header">
                <h2>Performance Metrics</h2>
                <button class="modal-close" onclick="closeMetricsModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="padding: 0;">
                    <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                        <select id="metrics-pi-filter" onchange="loadMetrics()" class="form-control" style="flex: 1;">
                            <option value="">All Printers</option>
                        </select>
                        <select id="metrics-time-range" onchange="loadMetrics()" class="form-control" style="width: 150px;">
                            <option value="1">Last Hour</option>
                            <option value="6">Last 6 Hours</option>
                            <option value="24" selected>Last 24 Hours</option>
                            <option value="168">Last Week</option>
                        </select>
                    </div>
                </div>
                
                <!-- Metrics Summary Cards -->
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">Avg CPU Usage</span>
                            <i data-lucide="cpu" class="stat-icon blue"></i>
                        </div>
                        <div class="stat-value" id="avg-cpu">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">Avg Memory</span>
                            <i data-lucide="hard-drive" class="stat-icon purple"></i>
                        </div>
                        <div class="stat-value" id="avg-memory">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">Total Jobs</span>
                            <i data-lucide="file-text" class="stat-icon green"></i>
                        </div>
                        <div class="stat-value" id="total-jobs">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">Success Rate</span>
                            <i data-lucide="check-circle" class="stat-icon green"></i>
                        </div>
                        <div class="stat-value" id="success-rate">0%</div>
                    </div>
                </div>
                
                <!-- Metrics Table -->
                <div style="background: var(--bg-primary); border-radius: 8px; padding: 16px;">
                    <h3 style="margin: 0 0 16px 0; font-size: 16px;">Detailed Metrics</h3>
                    <div style="overflow-x: auto;">
                        <table id="metrics-table" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 2px solid var(--border-color);">
                                    <th style="text-align: left; padding: 8px;">Printer</th>
                                    <th style="text-align: center; padding: 8px;">CPU %</th>
                                    <th style="text-align: center; padding: 8px;">Memory %</th>
                                    <th style="text-align: center; padding: 8px;">Queue</th>
                                    <th style="text-align: center; padding: 8px;">Jobs</th>
                                    <th style="text-align: center; padding: 8px;">Failed</th>
                                    <th style="text-align: left; padding: 8px;">Last Update</th>
                                </tr>
                            </thead>
                            <tbody id="metrics-tbody">
                                <!-- Metrics rows will be added here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Queue Management Modal -->
    <div id="queue-modal" class="modal">
        <div class="modal-content" style="max-width: 1400px;">
            <div class="modal-header">
                <h2>Queue Management</h2>
                <button class="modal-close" onclick="closeQueueModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="padding: 0;">
                    <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                        <select id="queue-pi-filter" onchange="loadQueue()" class="form-control" style="flex: 1;">
                            <option value="">All Printers</option>
                        </select>
                        <button class="btn btn-primary" onclick="refreshQueue()">
                            <i data-lucide="refresh-cw" style="width: 16px; height: 16px;"></i>
                            Refresh
                        </button>
                        <button class="btn btn-danger" onclick="clearQueue()">
                            <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
                            Clear Queue
                        </button>
                    </div>
                </div>
                
                <!-- Queue Stats -->
                <div class="stats-grid" style="margin-bottom: 24px; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                    <div class="stat-card">
                        <div class="stat-value" id="queue-total">0</div>
                        <div class="stat-label">Total Jobs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="queue-queued">0</div>
                        <div class="stat-label">Queued</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="queue-processing">0</div>
                        <div class="stat-label">Processing</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="queue-completed">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="queue-failed">0</div>
                        <div class="stat-label">Failed</div>
                    </div>
                </div>
                
                <!-- Queue Table -->
                <div style="background: var(--bg-primary); border-radius: 8px; padding: 16px;">
                    <h3 style="margin: 0 0 16px 0; font-size: 16px;">Active Print Jobs</h3>
                    <div style="overflow-x: auto;">
                        <table id="queue-table" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 2px solid var(--border-color);">
                                    <th style="text-align: left; padding: 12px;">Position</th>
                                    <th style="text-align: left; padding: 12px;">Job ID</th>
                                    <th style="text-align: left; padding: 12px;">Printer</th>
                                    <th style="text-align: left; padding: 12px;">Status</th>
                                    <th style="text-align: left; padding: 12px;">Priority</th>
                                    <th style="text-align: left; padding: 12px;">Created</th>
                                    <th style="text-align: left; padding: 12px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="queue-tbody">
                                <!-- Queue items will be added here -->
                            </tbody>
                        </table>
                        <div id="queue-empty" style="text-align: center; padding: 40px; color: var(--text-secondary); display: none;">
                            <i data-lucide="inbox" style="width: 48px; height: 48px; margin-bottom: 16px;"></i>
                            <p>No active jobs</p>
                            <p style="font-size: 13px; margin-top: 8px;">All jobs have been completed or there are no pending jobs</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Job Details Modal -->
    <div id="job-details-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Job Details</h2>
                <button class="modal-close" onclick="closeJobDetailsModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body" id="job-details-content">
                <!-- Job details will be populated here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeJobDetailsModal()">Close</button>
                <button id="job-retry-btn" class="btn btn-warning" onclick="retryJob()" style="display: none;">
                    <i data-lucide="refresh-cw" style="width: 16px; height: 16px;"></i>
                    Retry Job
                </button>
                <button id="job-cancel-btn" class="btn btn-danger" onclick="cancelJob()" style="display: none;">
                    <i data-lucide="x-circle" style="width: 16px; height: 16px;"></i>
                    Cancel Job
                </button>
            </div>
        </div>
    </div>

    <!-- Create API Key Modal -->
    <div id="create-key-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create API Key</h2>
                <button class="modal-close" onclick="closeCreateKeyModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <form id="create-key-form" onsubmit="createApiKey(event); return false;">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="key-name">Key Name *</label>
                        <input type="text" id="key-name" class="form-control" required placeholder="e.g., Production Server">
                    </div>
                    <div class="form-group">
                        <label for="key-description">Description</label>
                        <textarea id="key-description" class="form-control" rows="3" placeholder="Optional description for this API key"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateKeyModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Key</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Label Size Modal -->
    <div id="add-label-size-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Label Size</h2>
                <button class="modal-close" onclick="closeAddLabelSizeModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <form id="add-label-size-form" onsubmit="addLabelSize(event); return false;">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="size-name">Name *</label>
                        <input type="text" id="size-name" class="form-control" required placeholder="e.g., Small Shipping Label">
                    </div>
                    <div class="form-group">
                        <label for="size-width">Width (mm) *</label>
                        <input type="number" id="size-width" class="form-control" required min="1" placeholder="57">
                    </div>
                    <div class="form-group">
                        <label for="size-height">Height (mm) *</label>
                        <input type="number" id="size-height" class="form-control" required min="1" placeholder="32">
                    </div>
                    <div class="form-group">
                        <label for="size-description">Description</label>
                        <textarea id="size-description" class="form-control" rows="2" placeholder="Optional description"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeAddLabelSizeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Label Size</button>
                </div>
            </form>
        </div>
    </div>

    <!-- New API Key Display Modal -->
    <div id="new-key-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>API Key Created</h2>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning" style="margin-bottom: 20px;">
                    <strong>Important:</strong> Copy this API key now. You won't be able to see it again!
                </div>
                <div class="form-group">
                    <label>API Key</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="new-api-key" class="form-control" readonly style="font-family: monospace;">
                        <button class="btn btn-primary" onclick="copyApiKey()">
                            <i data-lucide="copy"></i>
                            Copy
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeNewKeyModal()">Done</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Floating GitHub Button -->
    <a href="https://github.com/Baanaaana/LabelBerry" 
       target="_blank" 
       class="github-float" 
       title="View on GitHub">
        <i data-lucide="github" style="stroke: white;"></i>
    </a>

    <script src="/static/js/dashboard.js?v={{ static_version }}"></script>
    <script>
        // Initialize Lucide icons with custom size
        lucide.createIcons({
            attrs: {
                width: 20,
                height: 20
            }
        });
        
        // Re-initialize icons after dynamic content updates
        const originalRenderPrinters = window.renderPrinters;
        window.renderPrinters = function(pis) {
            originalRenderPrinters(pis);
            setTimeout(() => lucide.createIcons({
                attrs: {
                    width: 20,
                    height: 20
                }
            }), 10);
        };
    </script>
</body>
</html>